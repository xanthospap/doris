\chapter{The DORIS System}
\label{ch:doris-system}

\section{Questions}
\begin{enumerate}
  \item Should i parse the log files and add \texttt{Height above ground mark}
    to get the ``real'' height of the beacon refrence point ?

  \item \label{itm:q-state-transition-matrix} i need to turn the state 
  matrix (from variational eq) to ECEF (from GCRS)

  \item \label{itm:q-clock-rel-correction} Is the clock induced relativistic 
  correction ok? especially for the velocity components (should they be in ECEF)?.

  \item \label{itm:q-clock-travel-correction} Compute travel time relativistic 
  correction

  \item RINEX file in config mentions station'SYQB'. In the IDS logs, i can 
  only find SYPB and SYOB, for site SYOWA

  \item Same as above for 'SOFC SOCORRO'

  \item same for 'GR[34]B GRASSE'
\end{enumerate}

\section{DORIS Observation Equation}
\label{sec:doris-observation-equation}

\subsection{Doppler Count}
\label{ssec:doppler-count}
In the following, we will use the notation:
\begin{description}
  \item[$\tau$] proper time, e.g. a time tag in the time-scale of the receiver
  \item[$t$] coordinate time, e.g. a time tag in TAI
\end{description}

$N_{DOP}$, aka the \emph{Doppler measurement} is the count, by the receiver 
electronics, of the number of cycles of the difference $N_e$ (cycles sent by the 
emitter, $N_e=f_e \Delta \tau_e$) and $N_r$ (cycles generated by the receiver, 
$N_r=f_r \Delta \tau_r$). In practice, this is computed by the difference of two, 
consecutive \texttt{L2GHz} observation values (for the same beacon) in the 
RINEX file. This difference is given in the proper time-scale of the receiver.

Note that:
\begin{equation}
  \begin{split}
    N_{DOP} & = N_e - N_r\\
            & = f_e \Delta\tau_e - f_r \Delta\tau_r
  \end{split}
\end{equation}

\subsection{Observation Equation}
\label{ssec:observation-equation}
Following \cite{lemoine-2016}, we use the following observation equation:
\begin{equation}
  \begin{aligned}
    V_{observed} &= \frac{c}{f_{eN}} 
      \left( f_{eN} - f_{rT} - \frac{N_{DOP}}{\Delta _{\tau_r}} \right)
      + \Delta _{V_{IONO}} + \Delta _{V_{REL_C}} \\
    V_{theoretical} &= \frac{\rho_2 - \rho_1}{\Delta _{\tau_r}} + \Delta _{V_{TROPO}} 
      - \frac{c}{f_{eN}} \left( \frac{N_{DOP}}{\Delta _{\tau_r}} + f_{rT} \right) 
      \frac{\Delta f_e}{f_{eN}}
  \end{aligned}
\end{equation}
where $f_{eN}$ is the ``nominal'' emitter frequency (see \ref{sec:beacon-nominal-frequencies}), 
$f_{rT}$ is the ``true'' receiver frequency (see \ref{sec:true-nominal-frequencies}), 
$\frac{\Delta f_e}{f_{eN}}$ is the relative emitter frequency offset  
(via $f_{eT} = f_{eN} \left( 1 + \frac{\Delta f_e}{f_{eN}} \right)$), 
$N_{DOP}$ is the Doppler count (see \ref{ssec:doppler-count}), $\Delta _{\tau_r}$ 
is the proper time difference between two consecutive $L_{2GHz}$ measurements, 
$\Delta _{V_{IONO}}$ is the time-differenced ionospheric correction between two 
consecutive $L_{2GHz}$ measurements (see \ref{sec:ionospheric-refraction}), 
$\Delta _{V_{TROPO}}$ is the time-differenced tropospheric correction between 
two consecutive $L_{2GHz}$ measurements (see \ref{sec:tropospheric-refraction}) 
and $\Delta _{V_{REL_C}}$ is the time-differenced relativistic clock correction 
between two consecutive $L_{2GHz}$ measurements (see \ref{sec:relativistic-correction}).

%\textbf{Range Rate}\\
%\label{range-rate}
%Suppose that the two consecutive measurements are performed at $\tau_{r_1}$ 
%and $\tau_{r_2}$ respectively, at the receiver proper time. We must compute the 
%``\emph{theoretical}'' range-rate value (to compare it with the value observed).
%According to \cite{Montenbruck2000}, the formula for computing range-rate is:
%\begin{equation}
%  \dot{\rho} = \frac{\rho_{\tau_{r_2}} - \rho_{\tau_{r_1}}}{\tau_{r_2} - \tau_{r_1}}
%\end{equation}
%In the implementation, the formula is computed using \emph{topocentric} vectors 
%(with origin at the beacon). Hence $\rho_{\tau_{r_1}}$ and $\rho_{\tau_{r_2}}$ are 
%actualy $\rho_{\tau_{r_1}}^{enu}$ and $\rho_{\tau_{r_2}}^{enu}$.
%
%Note, that the above is different from the \emph{instataneous} range rate, 
%which is computed via (\cite{Montenbruck2000})
%\begin{equation}
%  \dot{\rho} = \dot{s} = \frac{\bm{s} \bm{\dot{s}}}{s}
%\end{equation}

\section{Coordinate and Proper Time}
\label{sec:coordinate-and-proper-time}
We distingiush between to different times-scales:
\begin{itemize}
  \item \emph{Proper time} $\tau$, which is the time implemented by the receiver 
    electronics, and
  \item \emph{Coordinate time} $t$ which is considered as the TCG time-scale.
  {\color{brown}For simplicity, we are using TAI as the coordinate time system, not TCG.}
\end{itemize}

Within the RINEX files \cite{DORISRNX3},
\begin{displayquote}
  The timing of events such as phase sampling and pseudo-range acquisition are 
  given in the receiver time scale.
\end{displayquote}
and
\begin{displayquote}
  This epoch is by construction the instrument time of the event corrected for 
  instrumental delays, so that it is the time at which the event happened at the 
  phase center of the antenna.
  The TAI time of these events can be obtained by adding the Receiver clock 
  offset to the epoch.
\end{displayquote}

In practice, when going through a RINEX file we have two timestamps: 
\textit{(a)} $\tau _i$, which is the time recorded in the (data header block) 
RINEX, and \textit{(b)} $t_i$ which is $\tau _i$ corrected using the 
\texttt{Receiver CLock Offset} provided in the RINEX file for each epoch.

%Notes:
%  TCG is a time coordinate system of the IAU spacetime metric called 
%  geocentric celestial reference system, GCRS \cite(SOFA20210125), Sec. 3.6.3
%  Geocentric coordinate time, TCG, is appropriate for theoretical studies of 
%  geocentric ephemerides. Its relationship with TT is this conventional linear 
%  transformation:
%  \begin{equation}
%    TCG = TT + L_G \cdot (JD_{TT} - TT_0)
%  \end{equation}
%  where $TT_0=2443144.5003725$ (i.e. TT at 1977 January 1.0 TAI), $JD_{TT}$ is 
%  TT expressed as Julian date, and $L_G = 6.969290134 \cdot 10-10$ 
%  (\cite{SOFA20210125}, Sec. 3.6.4).
%  To within $10^{-18}$ in rate, we can use the approximation (\cite{iers2010}):
%  \begin{equation}
%    TCG - TT = L_G \cdot \left( MJD - 43144.0 \right) \cdot 86400 \text{ [sec]}
%  \end{equation}
%  where $MJD$ refers to the modified Julian date of TAI ($TT=TAI+32.184\text{ sec}$)

\section{Beacon Nominal Frequencies}
\label{sec:beacon-nominal-frequencies}
The RINEX file contains a \emph{station frequency shift factor} for each of the 
beacons included. This is used to compute the ``nominal'' frequencies of the 
beacon/emitter. Usually, this shift factor is just $0$, but it can be an integer 
$k \neq 0$. The frequencies are computed as:
\begin{equation}
  \begin{aligned}
    L_{2GHz}   &= 543 \cdot F_0 \left( \frac{3}{4} + \frac{87\cdot k}{5 \cdot 2^{26}} \right) \\
    L_{400MHz} &= 107 \cdot F_0 \left( \frac{3}{4} + \frac{87\cdot k}{5 \cdot 2^{26}} \right) 
  \end{aligned}
\end{equation}
where $F_0 = 5e6 \text{ Hz}$ the USO frequency.

Note that regardless of the beacon's frequency shift factor $k$, the $\gamma$ 
value, given by $\gamma = \left( \frac{f_{2GHz}}{f_{400MHz}} \right) ^2$ remains 
the same.

\section{True and Nominal Frequencies}
\label{sec:true-nominal-frequencies}
The ``true'' frequencies emitted and received, are in fact slightly different 
than the nominal ones. To quantify this difference, we will use the 
\emph{relative frequency offset} factor, $\Delta f_e / f_{e,Nominal}$ and 
$\Delta f_r / f_{r,Nominal}$ for the emitter and the receiver respectively. 
Hence, from now on, we will use the subscript $N$ for nominal frequencies and 
$T$ for the true ones, using the relations:
\begin{equation}
  \begin{aligned}
    f_{eT} &= f_{eN} \cdot \left( 1 + \frac{\Delta f_e}{f_{eN}} \right) \\
    f_{rT} &= f_{rN} \cdot \left( 1 + \frac{\Delta f_r}{f_{rN}} \right) \\
  \end{aligned}
\end{equation}

Due to correlation between the relative frequency offsets (of the emitter and 
the receiver), it is only possible to estimate one of the two. Following 
\cite{lemoine-2016}, we choose to estimate the $\Delta f_e / f_{eN}$ (per beacon) 
factors. This means that we must use a known/computed value for $\Delta f_{rN}$. 
{\color{brown}There are a couple of ways to compute $\Delta f_r / f_{rN}$, 
the most simple one being using the RINEX values reported every epoch.}
Thus, for every epoch, we will use the RINEX-reported value of \texttt{F} to 
compute the ``true'' frequency of the receiver as:
\begin{equation}
  f_{rT} = f_{rN} \cdot \left( 1 + F \cdot 1e-11 \right)
\end{equation}
where $f_{rN}$ is 2GHz and 400MHz for the first and second frequencies 
respectively.

We are going to estimate the $\Delta f_e$ values, using one estimate per beacon.

Using this approach, the \emph{observed} value of the range-rate becomes:
\begin{equation}
  \frac{c}{f_{eN}} \left( f_{eN} - f_{rT} - \frac{N_{DOP}}{\Delta \tau_{r}} \right) 
\end{equation}

\section{Measurement Flags}
\label{sec:measurement-flags}
Each observation (on each frequency) in the RINEX file is marked with two ``flags'', 
aka two distinct characters that follow the observation value and flag important 
events if any. Here, we will exclude observations if the following conditions are true:
\begin{description}
  \item[\texttt{L2GHz} or \texttt{L400MHz}] measurement is a ``central frequency'' 
  measurement (that is the first flag is an \texttt{1})
  \item[\texttt{L2GHz} or \texttt{L400MHz}] measurement is marked as discontinuity, 
  i.e. Loss-of-Lock has occured (that is the seconds flag is an \texttt{1})
  \item[power-level \texttt{W}] measurement (on either of the frequencies) flags 
  a beacon on restart mode (first flag is an \texttt{1})
\end{description}

\section{Ionospheric Refraction}
\label{sec:ionospheric-refraction}
For each observation, the ionosphere-induced delay is computed using both 
(carrier) phase measurements. The correction, for each observation, is: 
(\cite{lemoine-2016}):
\begin{equation}
  L_{iono-free-2GHz} = L_{2GHz} 
    + \frac{L_{2GHz} - \sqrt \gamma L_{400MHz}}{\gamma - 1} 
    \text{ in [cycles]}
\end{equation}

{\color{brown}For his computation we use the measured $L_{2GHz}$ and $L_{400MHz}$ 
ccyles from the RINEX files. SHould we take into consideration the distinction 
of nominal/true frequencies and e.g. use a cycle scale factor?}

For the observation equation, we should differentiate the ionospheric delays on 
(the) two consecutive observations, to compute $\Delta u_{ION}$. Thus,
\begin{equation}
  \Delta u_{ION} = \frac{c}{f_{rN}} \left( L_{iono-free-2GHz}^{\tau_{r_2}} 
    - L_{iono-free-2GHz}^{\tau_{r_1}} \right) / (\tau_{r_2} - \tau_{r_1})
    \text{ in [m/sec]}
\end{equation}
Note that the above means that we are now referencing a ``iono-free'' phase center, 
different than the L2GHz phase center.

\section{Tropospheric Refraction}
\label{sec:tropospheric-refraction}
For each observation we have to compute the tropospheric delay. This is done 
using the GPT3/VMF3 model. GPT3 uses a grid to compute values for various 
atmospheric parameters (e.g. pressure, temperature, etc). VMF3 computes mapping 
functions values $mf_{el}^{wet}$ and $mf_{el}^{hyd}$ for given elevation/zenith 
angles.

For the hydrostatic zenith path delay $L_{z}^{hyd}$, we use the 
``refined'' Saastamoinen formula. An approximate, a-priori value for the 
respective wet delay $L_{z}^{wet}$ can be computed using the Aske \& Nordius 
formula. Finaly:
\begin{equation}
  \Delta _{trop} = L_{z}^{hyd} \cdot mf_{el}^{hyd} 
                 + L_{z}^{wet} \cdot mf_{el}^{wet} \text{ in [m]}
\end{equation}

As with the ionosphere, when considering the Doppler observation equation, we 
should get the differential correction betwee two consecutive observations,
\begin{equation}
  \begin{split}
  \label{eq:dutropo}
  \Delta u_{TRO} & = \left( \Delta _{trop}^{\tau_{r_2}} 
                  - \Delta _{trop}^{\tau_{r_1}} \right)
                    / (\tau_{r_2} - \tau_{r_1}) \\
                 & = \frac{L_{z,\tau_{r_2}}^{hyd} \cdot mf_{el,\tau_{r_2}}^{hyd} 
                   - L_{z,\tau_{r_1}}^{hyd} \cdot mf_{el,\tau_{r_1}}^{hyd} 
                   + L_{z}^{wet} \left( mf_{el,\tau_{r_2}}^{wet} - mf_{el,\tau_{r_1}}^{wet} \right)}
                   {\tau_{r_2} - \tau_{r_1}} \\
                 & \text{ in [m/sec]}
  \end{split}
\end{equation}

For every observation, a call to GPT3 is made to compute various quantities, 
that depend both on time and (beacon) coordinates. A call to VMF3 is performed 
to compute the mapping functions $mf_{el,\tau_i}^{wet}$ and $mf_{el,\tau_i}^{hyd}$.
Again, for every observation/beacon we compute the zenith hydrostatic delay 
$L_{z,\tau_i}^{hyd}$. The zenith wet delay $L_{z}^{wet}$ is considered a 
constant for one satellite pass (to be estimated). An a-priori value is 
computed using the Aske \& Nordius formula and the value is estimated as a 
(filter) parameter.

Considering \ref{eq:dutropo}, the following {\color{lime} simplified} partial 
derivatives are derived:
\begin{align}
  \frac{\partial \Delta u_{TRO}}{\partial \bm{r}_{beacon}}    
    &= \frac{\partial \Delta u_{TRO}}{\partial \bm{v}_{beacon}} = \bm{0} \\
  \frac{\partial \Delta u_{TRO}}{\partial \bm{r}_{satellite}} 
    &= \frac{\partial \Delta u_{TRO}}{\partial \bm{v}_{satellite}} = \bm{0} \\
  \frac{\partial \Delta u_{TRO}}{\partial L_{z}^{wet}} 
    &= \frac{mf_{el,\tau_{r_2}}^{wet} - mf_{el,\tau_{r_1}}^{wet}}{\tau_{r_2} - \tau_{r_1}}
\end{align}

\section{Relativistic Corrections}
\label{sec:relativistic-correction}
According to \cite{lemoine-2016}, relativistic correction can be split into two 
parts, $\Delta_{rel_C}$, which is the clock correction, and $\Delta_{rel_r}$ 
which is the travel-time correction. They are given respectively by:
\begin{equation}
  \label{eq:relativistic-clock-correction}
  \Delta_{rel_C} = \frac{1}{c} \left( U_r - U_e + \frac{V_r^2 -V_e^2}{2} \right)
\end{equation}
\begin{equation}
  \Delta_{rel_r} = \frac{2\mu}{\Delta \tau _r c^2} 
    \left( \ln{\frac{R_1+R_{1'}+\rho_1}{R_1+R_{1'}-\rho_1}} 
      - \ln{\frac{R_2+R_{2'}+\rho_2}{R_2+R_{2'}-\rho_2}} \right)
\end{equation}
{\color{brown}At this point, we are only considering the relativistic clock correction!} 
(see \ref{itm:q-clock-travel-correction}).

In \ref{eq:relativistic-clock-correction}, the subscript \texttt{e} denotes the 
emitter which in DORIS is the beacon, which is located on the surface of the 
Earth, close to the geoid. Hence, we can use the approximation:
\begin{equation}
  U_e + V_e^2 / 2 = \mu / r_{beacon}^{ecef}
\end{equation}

On the other hand, the gravitational potential for a LEO satellite cannot be 
approximated adequately using only the fist term. Hence, we will include the 
$J_2$ term so that:
\begin{equation}
  U_r = \frac{\mu}{r_{satellite}^{ecef}} - 
    \left( 1 - \left( \frac{\alpha _e}{r_{satellite}^{ecef}} \right) ^2 
      \cdot J_2 \cdot \frac{3 \sin^{2}{\phi} -1}{2} \right)
\end{equation}
where $\alpha _e$ is the equatorial radius of the earth. The term $V_r$ is 
simply the norm of the satellite's {\color{brown}velocity vector in ECEF}.
Is this last sentence correct (see \ref{itm:q-clock-rel-correction})?

\section{Beacon Coordinates and Reference Points}
\label{sec:beacon-coordiates-and-reference-points}

\subsection{Site Eccentricities and Beacon ARP}
\label{ssec:site-eccentricities-and-beacon-arp}
Site coordinates are extracted from the \texttt{dpod2014\_053.snx} file, and 
extrapolated to first epoch of the RINEX file. {\color{brown} Loading/Tidal site 
displacements are ot yet considered}, hence the beacon position is considered 
stable for all measurements in the RINEX file.

I assume here, that the extrapolated coordinates correspond to a point (probably 
on the ground) that is not the same as the beacon/antenna reference point (ARP). 
To go from the site coordinates to the beacon/antenna ARP, i use the IDS-published 
log files. These contain $\Delta height$ values, to correct for the site-to-ARP 
eccentricity. Hence, in a first step, the extrapolated \texttt{dpod2014\_053.snx} 
coordinates are corrected for the height eccentricity, and the resulting 
coordinates are assumed to describe the beacon ARP. The eccentricity is applied 
in a topocentric RF, as:
\begin{equation}
  \bm{r}_{ARP}^{ecef} = \bm{r}_{dpod}^{ecef} + \bm{R}^T \cdot 
    \begin{bmatrix} 0\\ 0\\ \Delta height\end{bmatrix}
\end{equation}
where $\bm{R}$ is the cartesian-to-topocentrix matrix (centered at $\bm{r}_{dpod}^{ecef}$).

\subsection{Iono-Free Phase Center}
\label{ssec:iono-free-phase-center}
Because we are using iono-free 2GHz measuremets, we must ``reduce'' the beacon 
coordinates to reference the iono-free phase center (and not the ARP). For this, 
we procced as \cite{lemoine-2016}, aka the vector from the beacon ARP to the
2GHz-iono-free phase center is:
\begin{equation}
  \bm{r}'_{iono-free-2GHz} = \bm{r}_{2GHz} + 
    \frac{\bm{r}_{2GHz} - \bm{r}_{400MHz}}{\gamma - 1}
\end{equation}
Note that vectors used in this equation (aka $\bm{r}_{2GHz}$ and $\bm{r}_{400MHz}$) 
are w.r.t a topocentric reference frame, centered at the beacon ARP (that is they 
are given as eccentricities).

The actual computation for this reduction, that is from $\bm{r}_{ARP}^{ecef}$ 
to $\bm{r}_{iono-free-2GHz}^{ecef}$ we use:
\begin{equation}
  \bm{r}_{iono-free-2GHz}^{ecef} = \bm{r}_{ARP}^{ecef} + \bm{R}^T \cdot \bm{r}'_{iono-free-2GHz}
\end{equation}

\section{The Kalman Filter}
\label{sec:the-kalman-filter}
The Kalman filter is implemented as an  Extended Kalman Filter (EKF). The parameters 
estimated are:
\begin{itemize} 
  \item $6$ parameters for the satellite state, $\begin{bmatrix} x\\ y\\ z\\ \dot{x}\\ \dot{y}\\ \dot{z}\end{bmatrix}$
  \item $1$ parameter per beacon for the relative frequency offset of the emitter, $\Delta f_{e} / f_{eN}$, and
  \item $1$ parameter per beacon, per pass for the tropospheric zenith wet delay, $L_{z}^{wet}$
\end{itemize}

Initial values for the state vector are extracted from an sp3 file; we inspect 
the sp3 file for a record closest to (but not larger than) the first epoch 
encountered in the RINEX file that has valid measurements. Std. deviation values 
are assumed as $1$ [meter] for position and $0.5$ [m/sec] for velocity components.

Initial values for the $\Delta f_{e} / f_{eN}$ values, are set to $1e-5$ with a 
corresponding (initial) std. deviation of $100$.

Initial values for the $L_{z}^{wet}$ values, are computed once for every new 
pass according to the \textit{Aske \& Nordius formula} (\ref{sec:tropospheric-refraction}) 
using an std. deviation of $0.5$ meters.

The a-priori weight matrix has no correlations.

The state transition matrix, to propagate covariance matrix, is the one 
computed in the integration step (when solving the ODE for the variational 
equations).


%% This declares a command \Comment
%% The argument will be surrounded by /* ... */
\SetKwComment{Comment}{/* }{ */}
\SetAlFnt{\footnotesize}

\begin{algorithm}
\caption{An algorithm with caption}\label{alg:two}
%\KwData{MinElevationAngle}
%\KwIn{RINEX}

\BlankLine
readRinexHeader

\ForEach{$beacon$ in RINEX} {
  \Comment{Extrapolate PDOP coordinates and apply eccentricities}
  $\bm{r}_{ARP}^{ecef}$, see \ref{sec:beacon-coordiates-and-reference-points}
}

\Comment{Initialize the Kalman filter}
$Filter$, see \ref{sec:the-kalman-filter}


\ForEach{$dataBlock$ in RINEX}
{
  get current proper time $\tau_i$ (see \ref{sec:coordinate-and-proper-time})

  \Comment{Apply the receiver clock offset $rco$ from RINEX to get to TAI}
  $t_i \gets \tau_i + \Delta_{rco}$\  (see \ref{sec:coordinate-and-proper-time})

  \Comment{Integrate satellite orbit to $t_i$, state GCRS-to-ECEF}
  Compute: $\bm{r}_{sat_{t_i}}^{ecef}$, $\bm{v}_{sat_{t_i}}^{ecef}$ and 
  state transition matrix $\Phi _{t_{i-1},t_i}$ (from var. equations), see 
  \ref{itm:q-state-transition-matrix}.

  \ForEach{$beacon$ in $dataBlock$} 
  {
    \eIf{observation flags not ok (see \ref{sec:measurement-flags})}
    {
      \lIf{previous observation exist}{mark discontinuity}
      skip observation
    }
    {
      \Comment{apply iono-free phase center correction to ARP}
      $\bm{r}_{sta} \gets \bm{r}_{ARP} + \Delta _{iono-free}$ 
      (see \ref{sec:beacon-coordiates-and-reference-points})

      \Comment{compute Azimouth, Elevation, and Range (ECEF-ENU)}
      $Az_{t_i}$, $El_{t_i}$, $\rho _{t_i}$

      \If{$El_{t_i} > MinElevationAngle$}
      {
        \Comment{nominal beacon frequency}
        compute $f_{eN}$ (\ref{sec:beacon-nominal-frequencies})

        \Comment{ionospheric correction (for this obs.)}
        $\Delta_{iono}$ (\ref{sec:ionospheric-refraction})

        \Comment{tropospheric correction (for this obs.)}
        $L_{z,t_i}^{hyd}$, $mf_{t_i}^{hyd}$, $mf_{t_i}^{wet}$ (see \ref{sec:tropospheric-refraction})

        \eIf{start of new pass}{
          compute $L_{z}^{wet}$ from \textit{Aske \& Nordius}
        }
        {
          retrieve filter value for $L_{z}^{wet}$
        }

        \Comment{relativistic correction (for this obs.)}
        $\Delta_{{rel}_c}$ (see \ref{sec:relativistic-correction})

        \If{this is a new arc \texttt{or} new beacon \texttt{or} recovering from discontinuity} 
        {
          store/update beacon data ($t_i$, $\Delta_{iono}$, $\Delta_{trop}$, etc)
        }
        {
          \Comment{receiver true proper frequency}
          $f_{rT}$ (see \ref{sec:true-nominal-frequencies})

          \Comment{compute doppler count}
          $N_{DOP} \gets L1_{\tau_i} - L1_{\tau_{i-1}}$, (see \ref{ssec:doppler-count})

          \Comment{differentiate ionospheric correction}
          $\Delta_{Uiono} \gets \frac{c}{f_{eN}} ( \Delta_{iono_{t\tau_i}} - \Delta_{iono_{t_{\tau-1}}} ) / \Delta \tau$ (see \ref{sec:ionospheric-refraction})

          \Comment{differentiate tropospheric correction}
          $\Delta_{Utrop} \gets ( \Delta_{trop_{\tau_i}} - \Delta_{trop_{\tau_{i-1}}} ) / \Delta \tau$ (see \ref{sec:tropospheric-refraction})

          \Comment{differentiate relativistic correction}
          $\Delta_{Urelc} \gets ( \Delta_{relc_{\tau_i}} - \Delta_{relc_{\tau_{i-1}}} ) / \Delta \tau$ (see \ref{sec:relativistic-correction})

          \Comment{Filter update}
          $\hat{\bm{x}}_{t_i}$
        }
      }
    }
  }
}

\end{algorithm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\iffalse
\chapter{DORIS System Theoretical Implications}
\label{ch:doris-theory}

\section{Introduction}
\label{sec:doris-introduction}

\begin{figure}
\centering
\input{tikz/doris-system-description.tex}
\caption{DORIS System Description}
\label{fig:doris-system-description}
\end{figure}

\section{Theoretical Model of Doppler Observations}
According to \cite{lemoine-2016}, we define four basic events:
\begin{enumerate}
    \item beginning of emission of the 1\textsubscript{st} cycle by the emitter, 
    \(\tau_{e1}\) in the proper time scale of the emitter and \(t_1\) in the coordinate 
    time
    
    \item beginning of reception of the the 1\textsubscript{st} cycle by the receiver, 
    \(\tau_{r1'}\) in the proper time scale of the receiver and 
    \(t_{1'}\) in the coordinate time

    \item end of emission of the N\textsubscript{th} cycle by the emitter, 
    \(\tau_{e2}\) in the proper time scale of the emitter and \(t_2\) in the coordinate 
    time
    
    \item end of reception of the N\textsubscript{th} cycle by the receiver, 
    \(\tau_{r2'}\) in the proper time scale of the receiver and 
    \(t_{2'}\) in the coordinate time
\end{enumerate}

During the proper time interval \(\Delta\tau_{r} = \tau_{r2'} - \tau_{r1'}\), 
the receiver has received the \(N_e\) cycles sent by the emitter, with \(N_e = f_e \Delta\tau_e\), 
\(f_e\) being the proper frequency of the emitter. The receiver is also equipped with
an oscilator and during the proper time interval \(\Delta\tau_{r}\) has generated 
a number \(N_r = f_r \Delta\tau_r\) of cycles, \(f_r\) being the proper frequency of the 
receiver.

The Doppler measurement is the count, by the receiver electronics, of the number 
of cycles of difference between \(N_e\) and \(N_r\):
\begin{equation}
    \begin{split}
    N_{DOP} & = N_e - N_r\\
            & = f_e \Delta\tau_e - f_r \Delta\tau_r
    \end{split}
\end{equation}

\emph{In the RINEX files, this Doppler count is the difference between two phase measurements 
done at different time tags in the proper time-scale of the receiver.}

After a series of assumptions and simplifications, we can derive the theoretical 
formula for the Doppler count \cite{lemoine-2016}:
\begin{equation}
    \begin{split}
        \frac{c}{f_e \Delta\tau_r} N_{DOP} & \approx c \frac{f_e - f_r}{f_e} \\
        & - (1 - \frac{U_e}{c^2} - \frac{{V_e}^2}{2 c^2}) \frac{\rho_2 - \rho_1}{\Delta\tau_r}\\
        & + \frac{1}{c} (U_r - U_e + \frac{{V_r}^2 - {V_e}^2}{2}) \\
        & + \frac{2 \mu}{c^2 \Delta\tau_r} [\ln{(\frac{R_1 + R_{1'} + \rho_1}{R_1 + R_{1'} - \rho_1})} - \ln{(\frac{R_2 + R_{2'} + \rho_2}{R_2 + R_{2'} - \rho_2})}]
    \end{split}
\end{equation}

where \(U\) is the gravitational potential, \(V\) is the velocity of the clock, \(R\) 
is the geometric distance and \(\rho\) is the curvlinear trajectory (of the photon(s)).

The above equation can be (arbitrarily) split into two parts, one containing the ``measured'' 
quantities and one with the ``theoretical'' terms, as \cite{lemoine-2016}:
\begin{subequations}\label{eq:lem12}
  \begin{align}
    u_{measured} & = \frac{c}{f_e} (f_e - f_r -
     \frac{N_{DOP}}{\Delta\tau_r}) + \Delta u_{REL} \label{eq:lem12a} \\
    u_{theo}     &= \frac{\rho_2 - \rho_1}{\Delta\tau_r} (1- \frac{U_e}{c^2} - 
      \frac{{V_e}^2}{2 c^2}) \label{eq:lem12b}
  \end{align}
\end{subequations}

with
\begin{equation}
    \begin{split}
        \Delta u_{REL} &= \frac{1}{c} (U_r - U_e + \frac{{V_r}^2 - {V_e}^2}{2}) \\
        & + \frac{2 \mu}{c^2 \Delta\tau_r} [\ln{(\frac{R_1 + R_{1'} + \rho_1}{R_1 + R_{1'} - \rho_1})} - \ln{(\frac{R_2 + R_{2'} + \rho_2}{R_2 + R_{2'} - \rho_2})}]
    \end{split}
\end{equation}

We now need to introduce some additional corrections:
\(\Delta u_{IONO}\) and \(\Delta u_{TROPO}\), are the propagation corrections of 
the radio electric signal through the ionosphere and troposphere respectively. 

Additionaly, in the actual case (measurements), the nominal frequencies \(f_e\) and \(f_r\) 
are not the ``true'' ones; we hence need to apply a relative correction (e.g. for the 
emmiter) \(f_{e_T} = f_{e_N} (1 + \frac{\Delta f_e}{f_{e_N}})\), where the subscript \(T\) 
denotes the ``True'' frequency and \(N\) the nominal one. Thus in \ref{eq:lem12} the 
terms \(f_e\) and \(f_r\) need to be substituted by \(f_{e_T}\) and \(f_{r_T}\) respectively.

We will place \(\Delta u_{IONO}\) and \(\Delta u_{REL}\) (which do not involve adjusted parameters) 
on the ``measured'' part of \ref{eq:lem12} and \(\Delta u_{TROPO}\) and \(\frac{\Delta f_e}{f_{e_N}}\) 
on the ``theoretical'' part; neglecting some minor terms, we reach the equation \cite{lemoine-2016}:
\begin{subequations} \label{eq:lem13}
    \begin{align}
        u_{measured} & = \frac{c}{f_{e_N}} (f_{e_N} - f_{r_T} -
          \frac{N_{DOP}}{\Delta\tau_r}) + \Delta u_{REL} + 
          \Delta u_{IONO} \label{eq:lem13a} \\
        u_{theo} &= \frac{\rho_2 - \rho_1}{\Delta\tau_r} 
          (1- \frac{U_e}{c^2} - \frac{{V_e}^2}{2 c^2}) + 
          \Delta u_{TROPO} - \frac{c(\frac{N_{DOP}}{\Delta\tau_r} + 
          f_{r_T})}{f_{e_N}} \frac{\Delta f_e}{f_{e_N}} \label{eq:lem13b}
    \end{align}
\end{subequations}

where 
\begin{itemize}
    \item \(u_{measured}\) is the measured relative velocity between the emitter and 
    the receiver between the events 1' and 2', based on the Doppler count \(N_{DOP}\), 
    corrected for the ionospheric and relativistic effects.

    \item \(u_{theo}\) is the the theoretical (computed) emitter/receiver relative velocity 
    between the events 1' and 2', corrected for the tropospheric effect and for a solved-for 
    frequency bias \(\frac{\Delta f_e}{f_{e_N}}\) of the emitter. \(f_{r_T} = f_{r_N} (1 + \frac{\Delta f_r}{f_{r_N}})\) 
    is an estimate of the proper frequency of the receiver.

    \item \(\Delta u_{REL} = \Delta u_{{REL}_c} + \Delta u_{{REL}_r}\) is the relativistic 
    correction, composed of two parts: the clock correction \(\Delta u_{{REL}_c}\) and the 
    travel correction \(\Delta u_{{REL}_r}\)
    \begin{subequations} \label{eq:lem14}
        \begin{align}
            \Delta u_{{REL}_c} & = \frac{1}{c} 
              (U_r - U_e + \frac{{V_r}^2 - {V_e}^2}{2}) \label{eq:lem14a}\\
            \Delta u_{{REL}_r} & = \frac{2 \mu}{c^2 \Delta\tau_r} \left[ 
              \ln{(\frac{R_1 + R_{1'} + \rho_1}{R_1 + R_{1'} - \rho_1})} - 
              \ln{(\frac{R_2 + R_{2'} + \rho_2}{R_2 + R_{2'} - \rho_2})} \right] \label{eq:lem14b}
        \end{align}
    \end{subequations}
\end{itemize}

Note that \ref{eq:lem13} can be further simplified to \ref{eq:lem17} by 
ommiting small terms (\ref{ssec:small-terms}).

\emph{Usually, one frequency offset and one tropospheric zenithal bias are adjusted per pass.}

\section{Implementation of the Doppler Observation Model}

\subsection{Small Terms}
\label{ssec:small-terms}

In \ref{eq:lem13}, the smallest terms are \(-U_e / c^2 - {V_e}^2 / 2 c^2\) and 
\(\Delta u_{{REL}_T}\); in the case of DORIS they ammount to \num{11.} and 
\num{6.} \SI{10e-6}{\meter\per\second} respectively (\cite{lemoine-2016}). 
Furthermore, since the emitters are located on the ground, the term 
\(-U_e / c^2 - {V_e}^2 / 2 c^2\) is constant per station. This small 
relativistic offset is absorbed by the adjustment of \(\Delta f_e / f_{eN}\). 
So it is possibly to furher simplify \ref{eq:lem13} to:
\begin{subequations} \label{eq:lem17}
    \begin{align}
        u_{measured} & = \frac{c}{f_{e_N}} (f_{e_N} - f_{r_T} -
          \frac{N_{DOP}}{\Delta\tau_r}) + 
          \Delta u_{{REL}_C} + \Delta u_{IONO} \label{eq:lem17a}\\
        u_{theo} &= \frac{\rho_2 - \rho_1}{\Delta\tau_r} + \Delta u_{TROPO} - 
          \frac{c(\frac{N_{DOP}}{\Delta\tau_r} + f_{r_T})}{f_{e_N}} 
          \frac{\Delta f_e}{f_{e_N}} \label{eq:lem17b}
    \end{align}
\end{subequations}

\subsection{Correction of Aberration}

\subsection{Geopotential}
For a station on the geoid, the potential at the level of the station is the sum 
of the gravitational potential and the centrifugal potential due to the Earth's 
rotation: \(U_{GEO} = U_e + \frac{{V_e}^2}{2}\), which is a constant. For a station 
not located on the geoid, the quantity \(U_e + \frac{{V_e}^2}{2}\) will only depend 
on the height of the beacon above the geoid.

For the computation of the gravitational potential for \gls{leo} satellites, 
the pottential \(U_r\) cannot be restricted to the central term only and we must 
take into account the \(J_2\) term (at least, in addition to \(\mu / r\). The formula 
for the computation of the potential in this case is \cite{lemoine-2016}:
\begin{equation}
  \label{eq:lem18}
  U_r = \frac{\mu}{r} \left( 1- \left(\frac{\alpha_\Earth}{r}\right)^2 
    J_2 \frac{3 sin^2(\phi) - 1}{2} \right)
\end{equation}
with \(\alpha_\Earth\) the equatorial radious of the earth, \(r\) radial 
distance of the satellite (to the Earth's center), \(\phi\) latitude of the 
satellite and \(J_2 = 1.0826359 \dot 10^{-3}\) in the zero-tide system.

\subsection{True Proper Frequency of the Receiver}
\label{ssec:true-proprtfrequency-of-the-receiver}

For the term \(f_{r_T}\) that appears in \ref{eq:lem13}, we need an estimate of \(\Delta f_{r} / f_{r_N}\). 
This estimate can be obtained in one of the following ways \cite{lemoine-2016}:
\begin{enumerate}
    \item via the field ``F'' recorded for every single measurement in the DORIS 
    RINEX file (see \ref{ssec:relative-frequency-offset}); not that this estimation 
    is not very smooth, as noticed by \cite{GAO2015} and it is advisable, before 
    using it in \ref{eq:lem13}, to perform a linear (or polynomial) regression of 
    these estimates over one or a few days.

    \item It can also be obtained from a polynomial regression
    over the frequency oﬀsets estimated during the passes
    over the master beacons

    \item It can ﬁnally be estimated by the users themselves as a
    by-product of their re-computation of the timetagging polynomial (see \cite{MERCIER2010})
\end{enumerate}

\subsection{Ionospheric Correction}
A ﬁrst-order iono-free pseudo-range measurement on the \SI{2}{\GHz} channel is built by combining
the \SI{400}{\MHz} and \SI{2}{\GHz} measurements in the following way:
\begin{equation}
  C_{iono-free-2GHz} = \frac{\gamma C_{2GHz} - C_{400MHz}}{\gamma - 1}
\end{equation}
where \(\gamma\) is the square of the frequency ratio: 
\(\gamma = {(\frac{f_{2GHz}}{f_{400MHz}})}^2\).

Converting to iono-free phase measurement on the \SI{2}{\GHz} channel using 
\(c\)  the speed of light and \(L_{\alpha}\) is the phase measurements on the 
\(\alpha\) channel (\(\alpha\) = \SI{2}{\GHz} or \SI{400}{\MHz}), we get:

\begin{equation}
  \begin{aligned}
  L_{iono-free-2GHz} &= \frac{\gamma L_{2GHz} - 
    \sqrt{\gamma}L_{400MHz}}{\gamma - 1} \\
                     &= L_{2GHz} + \frac{L_{2GHz} - 
                        \sqrt{\gamma}L_{400MHz}}{\gamma - 1}
  \end{aligned}
\end{equation}

The coordinates of the iono-free phase centers are given by the following formula:
\begin{equation}
  \vec{\bm{r}}_{iono-free-2GHz} = \frac{\vec{\bm{r}}_{400MHz,2GHz}}{\gamma - 1}
\end{equation}
where \(\vec{\bm{r}}_{iono-free-2GHz}\) is the vector from the \SI{2}{\GHz} 
phase center to the iono-free phase center and \(\vec{\bm{r}}_{400MHz,2GHz}\) 
is the vector from the \SI{400}{\Hz} to the \SI{2}{\GHz} phase center. In 
DORIS, the iono-free phase centers are located a few mm away from the 
\SI{2}{\GHz} phase centers, in the direction opposite to the \SI{400}{\MHz} 
phase centers.
\fi