\subsubsection{Atmospheric Drag}\label{sssec:atmospheric-drag}

For \gls{leo} satellites, the largest non-gravitational force is the atmospheric 
drag. Despite its significance though, accurate modeling of aerodynamic forces 
is a very complex problem, requiring knowledge of the physical properties of the 
(upper) atmosphere, interaction of neutral gas and charged particles with the satellite's 
surfaces and precise knowledge of attitude with respect to atmospheric particle 
flux (\cite{Montenbruck2000}).

Drag is a decelerating force, directed opposite to the velocity of the satellite 
with respect to atmospheric flux. Minor contributions, including lift and binormal 
forces, can be safely ignored. A simple derivation of the acceleration induced 
to a satellite due to atmospheric drag can be found in \cite{Montenbruck2000}; 
following this formulation, drag induced acceleration can be computed from
\begin{equation}\label{eq:mont397}
  \bm{\ddot{r}} = -\frac{1}{2} C_{d} \frac{A}{m} \rho v_{r}^{2} \bm{\hat{e}}_v
\end{equation}
where
\begin{description}
  \item $\rho$ is the atmospheric density at the location of the satellite,
  \item $A$ is the satellite's cross-sectional area,
  \item $v_r$ is the velocity of the satellite relative to the atmosphere,
  \item $\bm{\hat{e}}_v = \bm{v}_r / \norm{\bm{v}_r}$ is the unit vector in the 
    direction of $v_r$
  \item $C_d$ is the \emph{drag coefficient}, a dimensionless quantity describing the 
    interaction of the atmosphere with the satellite's surface material. This parameter 
    is normally estimated during \gls{pod} procedure.
\end{description}

With the assumption that the atmosphere co-rotates with the Earth (thus partly 
ignoring the complex atmosphere dynamics), the relative velocity of the satellite 
with respect to the atmosphere, $\bm{v}_r$, is given by
\begin{equation}\label{eq:mont398}
  \bm{v}_r = \bm{v} - \bm{\omega}_{\Earth} \times \bm{r}
\end{equation}
which is a very good approximation even for \gls{pod} applications. According 
to \cite{Montenbruck2000}, the maximum observed deviations from this assumption 
lead to uncertainties in the drag force of less than 5\%. $\bm{v}$ and $\bm{r}$ 
are the inertial satellite velocity and position vectors, while 
$\bm{\omega}_{\Earth}$ is the Earth's angular velocity vector.

In the ideal case of a spherical spacecraft, the projected area $A$ 
would not change. For all other shapes however, $A$ needs to be computed using the 
space vehicle's attitude. It is typical to model such complex geometries using a 
collection of flat plates (macromodel), each with an area $A_i$ and outward normal 
unit vector $\hat{\bm{n}}_i$, expressed in the spacecraft body-fixed coordinate system.

The inclination of the $i$th plate to the relative velocity $\bm{v}_r$, is given by:
\begin{equation}\label{markley10110}
  \cos \theta _{i} = \begin{pmatrix}\mathcal{R}^T \hat{\bm{n}}_i \end{pmatrix}^T \left( \frac{\bm{v}_r}{\norm{\bm{v}_r}} \right)
\end{equation}

where $\mathcal{R}$ is the attitude matrix that rotates the \gls{gcrf} frame to the 
spacecraft body-fixed frame. Using this formulation, the projected area $A$ can 
be computed as the collection of the $N$ macromodel plates, i.e.
\begin{equation}
  A = \sum _{i=1}^{N} A_i \cdot 
  \begin{cases} 
    \cos \theta _{i} \text{, if } \cos \theta _{i} > 0 \text{ or }\\
    0 \text{, if } \cos \theta _{i} < 0
  \end{cases}
\end{equation}

\paragraph{Partial Derivatives}\label{par:atmospheric-drag-partials}
Differentiation of \autoref{eq:mont397} with respect to the $C_d$ parameter, yields
\begin{equation}
  \frac{\partial \ddot{\bm{r}}}{\partial C_d} = 
    -\frac{1}{2} \frac{A}{m} \rho \norm{v_r} \bm{v_r}
\end{equation}

From \autoref{eq:mont397} and \autoref{eq:mont398}, one can analytically derive the 
partials of the acceleration with respect to the satellite velocity vector
\begin{equation}
  \frac{\partial \ddot{\bm{r}}}{\partial \bm{v}} = 
  -\frac{1}{2} C_d \frac{A}{m} \rho \left( \frac{\bm{v_r}\bm{v}^T_r}{\norm{\bm{v_r}}} 
    + \norm{\bm{v_r}} \cdot \bm{I}_{3\times 3} \right)
\end{equation}

Correspondingly, the partial of the acceleration with respect to the satellite position 
vector, is given by
\begin{equation}
  \label{eq:mont784}
  \begin{aligned}
    \frac{\partial \ddot{\bm{r}}}{\partial \bm{r}} &= 
    -\frac{1}{2} C_d \frac{A}{m} \norm{v_r} \bm{v_r} \frac{\partial \rho}{\partial \bm{r}}
    -\frac{1}{2} C_d \frac{A}{m} \rho \left( \frac{\bm{v_r}\bm{v}^T_r}{\norm{\bm{v_r}}} 
    + \norm{\bm{v_r}} \cdot \bm{I}_{3\times 3} \right) \frac{\partial \bm{v}_r}{\partial \bm{r}} \\
    & = -\frac{1}{2} C_d \frac{A}{m} \rho \norm{v_r} \bm{v_r} \frac{\partial \rho}{\partial \bm{r}}
      -\frac{\partial \ddot{\bm{r}}}{\partial \bm{v}} \bm{\omega} 
  \end{aligned}
\end{equation}

In \autoref{eq:mont784}, the $\frac{\partial \rho}{\partial \bm{r}}$ term describes 
the dependence of atmospheric density on satellite position. Analytical derivation 
of this term is nearly impossible, due to the complexity of the atmospheric model 
used. Therefore, a numerical approach is followed to derive the density gradient, 
using the \emph{Difference Quotient Approximation}. Thus, the formula
\begin{equation}
  \begin{aligned}
  \frac{\partial \rho}{\partial \bm{r}}(\bm{r},t) 
    &= 
      \frac{\rho (\bm{r}+\delta \bm{r}, t)}{\delta \bm{r}} \\
    &= \begin{pmatrix}
      \frac{\rho (\bm{r}+\delta \bm{r}_x)}{\norm{\delta \bm{r}_x}} &
      \frac{\rho (\bm{r}+\delta \bm{r}_y)}{\norm{\delta \bm{r}_y}} &
      \frac{\rho (\bm{r}+\delta \bm{r}_z)}{\norm{\delta \bm{r}_z}} 
    \end{pmatrix}^T
  \end{aligned}
\end{equation}
is used, where $\delta \bm{r}_x$, $\delta \bm{r}_y$ and $\delta \bm{r}_z$ are vectors along 
the $x$, $y$ and $z$ axis respectively, and $\bm{r}$ is the satellite's position 
vector at instant $t$. The values of the vector components along the three axis, 
should be small enough to approximate the derivative (or more precisely the gradient) 
at the given point. Using unit vectors (of length \SI{1}{\meter} per component, i.e 
$\delta \bm{r}_x = \hat{\bm{x}}$), should yield realistic results; this is the 
default value used in our implementation. It should be noted that here it is 
implicitly assumed that the density function $\rho$ is differentiable within the 
given interval. In reality this means that no ``abrupt'' changes should occur within 
the spatial/temporal span considered.

\paragraph{Atmospheric Models}\label{par:atmospheric-models}
The most challenging term in \autoref{eq:mont397}, is the atmospheric density $\rho$ 
(at the location of satellite). This requires the modeling of complex properties 
and dynamics of the Earth's atmosphere. The latter is a highly demanding task, and 
a number of models have been introduced (often including empirical data) to 
target the question. In the upper atmosphere ($>\SI{100}{\km}$), apart from spatial 
and temporal variances, the density also depends on solar soft x-ray and extreme 
ultraviolet (EUV) output, as well as the geomagnetic activity. Hence, the density is 
considered as a function of altitude, solar ten-centimetre flux ($F10.7$) and the 
geomagnetic activity index ($A_p$). 

Different (upper) atmospheric models are available (for comparison and overview, 
see e.g. \cite{Doornbos2009}, \cite{Yang2022} and \cite{Vallado2014}) varying in 
methodology, input data, application criteria and demands, complexity and efficiency. 
In this Thesis, two atmospheric models were implemented, namely:
\begin{description}
  \item[NRLMSISE-00] model (\cite{nrlmsise00}), which is an empirical atmospheric model that 
extends from the ground to the exobase and describes the average observed behavior 
of temperature, various species densities, and mass density via a parametric 
analytic formulation. The model inputs are location, date and time, solar activity, 
and geomagnetic activity. It was developed by researchers in the US Naval Research 
Laboratory.
  \item[DTM-2020] model (\cite{Bruinsma2021}), a semi-empirical Drag Temperature Model (DTM) 
  to predict the Earth's thermosphere's temperature, density, and composition, 
  especially for orbit computation purposes. This model comes in two variations, 
  the ``operational'' version, driven by the trusted and established $F10.7$ and $A_p$ 
  indices for solar and geomagnetic activity and the ``research'' alternative which 
  is based on space weather observations not yet accredited operationally. Hence, 
  in the Thesis, the first, ``operational'' version is used.
\end{description}

In order to use the \texttt{NRLMSISE-00} and \texttt{DTM-2020} models, space weather data is needed, including 
an 81-day average of F10.7 flux\footnote{The solar radio flux at \SI{10.7}{\cm} (\SI{2800}{\MHz}) 
is an excellent indicator of solar activity. Often called the F10.7 index, it is 
one of the longest running records of solar activity, reported in ``solar flux units''. 
The F10.7 Index has proven very valuable in specifying and forecasting space weather, 
and tracks well with Extreme UltraViolet (EUV) emissions that impact the ionosphere 
and modify the upper atmosphere} (centered on day), daily F10.7 solar flux for previous 
day and daily magnetic index. This data can be obtained via the ``Space Weather Data'' 
records archived by \href{https://celestrak.org/}{CelesTrack} (\cite{Vallado2013}).

\paragraph{Implementation}\label{par:atmospheric-drag-implementation}

Implementing the atmospheric density models described above, is a challenging task. Not only due to
model complexity and the large number of computations involved, but also because 
it needs to be paired with space weather data spanning various time intervals 
(e.g. an 81-day average of $F10.7$ is needed at each epoch, as well as values of $A_p$ per 3-hour intervals). 
Obviously, the complete scheme must be efficient and robust, since computing atmospheric 
density is performed hundreds of times in a \gls{pod} process spanning considerable 
arcs.

Source code for implementing the above has been designed and implemented from 
scratch, for the purpose of this Thesis. It has undergone extensive testing for 
correctness and efficiency. The final design, is one that allows the incremental 
parsing of needed data, via a ``hunting process'' (i.e. storing current stream 
positions and using indexes for searching onward) and a one-time mapping of 
input file streams.

Acceleration (see \autoref{eq:mont397} and \autoref{eq:mont398}) and derivatives 
(see discussion in \autoref{par:atmospheric-drag-partials}) with respect to the 
parameters considered are also implemented in source code.
